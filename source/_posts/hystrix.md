---
title: Hystrix
author: XIA
categories:
  - SpringCloud
tags:
  - null
date: 2019-06-06 21:02:24
---

在微服务结构中，系统被分为很多的服务单元。服务运行在不同的进程中，服务之间通过远程调用的方式通信。若一个服务发生故障或延迟，而这些问题也会导致调用方的服务也导致延迟，此时调用方的请求不断增加，最终将会导致任务积压使服务瘫痪。所以需要一个用来隔离分布式服务故障的容错库，以防止微服务中一个任务出现故障导致其他服务因为请求积压导致整个系统发生“雪崩”的情况。

Hystrix就是解决这个问题的框架，它实现了断路器、线程隔离等一系列服务保护功能。同时Hystrix还具备服务降级、服务熔断、线程和信号隔离、请求缓存、请求合并和服务监控等功能。

# 执行流程

官方执行流程图:

![20180626195147874](https://xbxblog2.bj.bcebos.com/Hystrix%2F20180626195147874.png)

1. **创建HystrixCommand或HystrixObservableCommand对象**

   将外部服务的处理逻辑封装在run方法或construct方法。

   区别在于命令的执行方式上。

2. **命令执行**
   
   命令共有四种执行方式：
   
   > HystrixCommand用在依赖服务返回单个操作结果的时候。又两种执行方式
   >
   > 　　   -execute():同步执行。从依赖的服务返回一个单一的结果对象，或是在发生错误的时候抛出异常。
   >
   > 　　   -queue();异步执行。直接返回一个Future对象，其中包含了服务执行结束时要返回的单一结果对象。
   >
   > HystrixObservableCommand 用在依赖服务返回多个操作结果的时候。它也实现了两种执行方式
   >
   > 　　   -observe():返回Obervable对象，他代表了操作的多个结果，他是一个HotObservable
   >
   > 　　   -toObservable():同样返回Observable对象，也代表了操作多个结果，但它返回的是一个Cold Observable。
   >
   > 参考：https://www.cnblogs.com/happyflyingpig/p/8079308.html
   
   Hystrix内部大量使用了RxJava，而且HystrixCommand的execute方法的同步执行方式 ，通过流程图的执行方法关系，可以得知最终也是调用的toObservable方法，也是RxJava实现的。
   
3. **结果是否被缓存**

   若当前命令启用了请求缓存功能，并且该命令缓存命中，那么缓存的结果会立即返回。这个过程就是请求缓存。

4. **断路器是否打开**

   断路器是命令对象中的一个组件，用来实现快速失败。它可以根据命令执行情况或手动配置来决定是否打开。

   在命令结果没有被缓存命中的时候，Hystrix在执行命令前需要检查断路器的打开状态。如果断路器为打开状态，则跳转到fallback处理逻辑。当断路器为关闭状态则跳转到下一步来检查是否有可用资源来执行命令。

5. **线程池/请求队列/信号量是否占满**

   如果该命令相关的线程池/请求队列/信号量已经被占满，那么Hystrix不会执行该命令，而是转换到fallback处理逻辑。这里的线程池并不是容器的线程池而是每个依赖服务的专有线程池。

   Hystrix为每个命令创建一个线程池，每次执行命令都会从线程池中启动一个新的线程。具体:https://www.jianshu.com/p/df1525d58c20

6. **执行run或construct方法**

   这里执行的就是创建命令对象时封装的任务逻辑了。如果方法的执行时间超过了命令设置的超时阈值，那么当前处理线程将会抛出一个TimeoutException，然后执行fallback逻辑。

7. **计算断路器的健康度**

   Hystrix会将命令执行的情况报告给断路器，断路器会根据这些信息来决定是否打开。

8. **fallback处理**

   当命令执行失败的时候，Hystrix会进入fallbak的处理逻辑，这个过程通常被称为“服务降级”。fallback方法的逻辑应尽量不依赖于网络请求，通常使用一些静态逻辑处理。

9. **返回成功的响应**

   由流程图可以知道，命令的执行方法最终都是调用的toObservable方法。最终的返回是Observable对象形式，而具体的返回形式则是取决于第二步时的命令执行方式。

   ![image-20200408200932467](https://xbxblog2.bj.bcebos.com/Hystrix%2Fimage-20200408200932467.png)





其实Hystrix还是得多实践，这个框架的配置非常多，如果只靠看书写demo很容易忘，先了解执行流程吧。